---
# tasks file for ndelius
- name: (main) Set facts
  set_fact:
    wl_home: /u01/app/oracle/middleware/wlserver_10.3
    wl_port: 7001
    domain_home: '/u01/app/oracle/middleware/user_projects/domains/{{ domain_name }}'

- name: (main) Debug vars
  debug:
    msg: "{{ vars }}"
    verbosity: 2

- name: (main) set tag to indicate deployment
  ec2_tag:
    region: "{{ region }}"
    resource: "{{ instance_id }}"
    state: present
    tags:
      ndelius_version: "Deploying - {{ ndelius_version }}"

- name: (main) Set WebLogic startup params
  include: wl_params.yml
  become: yes
  become_user: oracle

- name: (main) Set WebLogic admin password
  include: admin_password.yml
  become: yes
  become_user: oracle

- name: (main) Setup security realm
  include: security_realm.yml
  become: yes
  become_user: oracle

- name: (main) Setup datasources
  when: setup_datasources
  include: datasources.yml
  become: yes
  become_user: oracle

- name: (main) Apply NDelius configuration
  include: nd_config.yml
  become: yes
  become_user: oracle

- name: (main) Deploy NDelius
  include: deploy_ndelius.yml
  become: yes
  become_user: oracle

- name: (main) Deploy jspell
  include: deploy_jspell.yml
  become: yes
  become_user: oracle

- name: (main) Install proxy to insert SSL header
  include: haproxy.yml

- name: (main) Cron job for nightly service restart
  become: yes
  cron:
    name: Restart WebLogic
    job: 'systemctl restart weblogic'
    special_time: '0 2 * * *'

- name: (main) Start weblogic
  become: yes
  systemd:
    name: weblogic.service
    state: restarted
    enabled: yes

- name: (main) set tag to indicate deployed ndelius_version
  ec2_tag:
    region: "{{ region }}"
    resource: "{{ instance_id }}"
    state: present
    tags:
      ndelius_version: "{{ ndelius_version }}"
